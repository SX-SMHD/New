name: Create and Auto-Approve Pull Request

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  create-or-fetch-pr:
    runs-on: ubuntu-latest
    outputs:
      PR_NUMBER: ${{ steps.check-pr.outputs.PR_NUMBER }}  # Store PR_NUMBER correctly

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Generate token
      id: generate-token
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ secrets.ISSUEREPOAPP_APP_ID }}
        private-key: ${{ secrets.ISSUEREPOAPP_PRIVATE_KEY }}

    - name: Configure Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

    - name: Create or update branch
      run: |
        git checkout -b update-test-md || git checkout update-test-md
        echo "Hello" >> test.md
        git add test.md
        git commit -m 'Append Hello to test.md file' || echo "No new changes to commit"

    - name: Pull latest changes
      run: |
        git fetch origin update-test-md || echo "No remote branch found"
        git rebase origin/update-test-md || echo "Rebase failed, continuing"
      env:
        GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}

    - name: Push changes
      run: git push origin update-test-md --force
      env:
        GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}

    - name: Check if PR exists (only from GitHub Actions)
      id: check-pr
      run: |
        sudo apt-get install -y jq  # Ensure jq is installed
        PR_RESPONSE=$(curl -s -X GET \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/pulls?head=${{ github.repository_owner }}:update-test-md")
        
        PR_NUMBER=$(echo "$PR_RESPONSE" | jq '[.[] | select(.user.login == "github-actions[bot]")][0].number')

        if [ "$PR_NUMBER" != "null" ] && [ -n "$PR_NUMBER" ]; then
          echo "PR already exists: #$PR_NUMBER"
        else
          echo "Creating a new PR..."
          PR_CREATE_RESPONSE=$(curl -s -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/pulls \
            -d '{
                  "title": "Append Hello to test.md",
                  "head": "update-test-md",
                  "base": "main",
                  "body": "This pull request appends Hello to the test.md file."
                }')
          PR_NUMBER=$(echo "$PR_CREATE_RESPONSE" | jq '.number')
          if [ "$PR_NUMBER" == "null" ] || [ -z "$PR_NUMBER" ]; then
            echo "❌ Failed to create PR. Response: $PR_CREATE_RESPONSE"
            exit 1
          fi
          echo "✅ Created PR: #$PR_NUMBER"
        fi

        # Correctly set PR_NUMBER as step output
        echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
        echo "PR_NUMBER=$PR_NUMBER" >> "$GITHUB_OUTPUT"

    - name: Output PR number
      run: echo "Final PR Number: ${{ steps.check-pr.outputs.PR_NUMBER }}"  # Correct reference

  approve-pr:
    needs: create-or-fetch-pr
    runs-on: ubuntu-latest
    steps:
    - name: Approve pull request
      env:
        PR_NUMBER: ${{ needs.create-or-fetch-pr.outputs.PR_NUMBER }}  # Retrieve correctly from outputs
      run: |
        if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" == "null" ]; then
          echo "❌ PR_NUMBER is empty. Cannot approve PR."
          exit 1
        fi

        RESPONSE=$(curl -s -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews" \
          -d '{
                "event": "APPROVE",
                "body": "Auto-approved by GitHub Actions"
              }')

        echo "Response: $RESPONSE"
